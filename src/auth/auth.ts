import { PrismaAdapter } from '@auth/prisma-adapter';
import NextAuth from 'next-auth';
import { ZodError } from 'zod';
import Credentials from 'next-auth/providers/credentials';
import bcryptjs from 'bcryptjs';

import { prisma } from '@/utils/prisma';
import { signInSchema } from '@/schema/zod';
import { getUserFromDb } from '@/utils/user';

export const { handlers, signIn, signOut, auth } = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [
    Credentials({
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      authorize: async (credentials) => {
        try {
          if (!credentials?.email || !credentials?.password) {
            throw new Error('Email and password are required.');
          }
          // –≤ —Å–ª—É—á–∞–µ —É—Å–ø–µ–ø–µ—à–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—É—á–∞–µ–º –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          const { email, password } = await signInSchema.parseAsync(
            credentials
          );

          // logic to verify if the user exists
          const user = await getUserFromDb(email);

          if (!user || !user.password) {
            // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            throw new Error('No user found with the given email.');
          }

          // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å (—ç—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É bcryptjs –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–≤—É—Ö –ø–∞—Ä–æ–ª–µ–π )
          // —Ç–∞–∫ –∫–∞–∫ –ø–∞—Ä–æ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω —Ç–æ –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –∏—Ö –Ω–∞–ø—Ä—è–º—É—é
          // –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ compare –∏–∑ bcryptjs –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å —Å –≤–≤–µ–¥–µ–Ω–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º

          const isPasswordValid = await bcryptjs.compare(
            password, // –ø–∞—Ä–æ–ª—å –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            user.password // –ø–∞—Ä–æ–ª—å, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
          );

          if (!isPasswordValid) {
            // –µ—Å–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ –≤–∞–ª–∏–¥–µ–Ω
            throw new Error('Incorrect data entry');
          }

          return { id: user.id, email: user.email };
        } catch (error) {
          if (error instanceof ZodError) {
            // Return `null` to indicate that the credentials are invalid
            return null;
          }
          // —É –Ω–∞—Å –Ω–µ—Ç else, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null –≤ —Å–ª—É—á–∞–µ –ª—é–±–æ–π –æ—à–∏–±–∫–∏
          return null;
        }
      },
    }),
  ],
});

// function PrismaAdapter(
//   prisma: any
// ): import('@auth/core/adapters').Adapter | undefined {
//   throw new Error('Function not implemented.');
// }

// handlers - –æ–±—ä–µ–∫—Ç —Å –≥–æ—Ç–æ–≤—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ NextAuth.js.
// signIn - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
// signOut - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
// auth - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û (middleware) –¥–ª—è –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü, —Ç—Ä–µ–±—É—é—â–∏—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
// authorize - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏  –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

///*********************************///

// 1. –§–∞–π–ª —Å Prisma (utils/prisma.ts)

/*
1.1 –ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
  import 'dotenv/config'  
  –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞ –≤ process.env.
  –¢–æ –µ—Å—Ç—å process.env.DATABASE_URL –±–µ—Ä—ë—Ç—Å—è –∏–∑ .env.

1.2 @prisma/adapter-pg + PrismaClient
  PrismaClient ‚Äî –≥–ª–∞–≤–Ω—ã–π –∫–ª–∏–µ–Ω—Ç ORM Prisma.
  PrismaPg ‚Äî –∞–¥–∞–ø—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–∫–ª—é—á–∞–µ—Ç Prisma –∫ pg (PostgreSQL driver).
  –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã Prisma —Å–∞–º —Å–æ–∑–¥–∞–≤–∞–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —Ç—ã —è–≤–Ω–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—à—å –∞–¥–∞–ø—Ç–µ—Ä —Å connectionString.

1.3. connectionString = process.env.DATABASE_URL!
  –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ (postgres://user:pass@host:port/db).
  ! –≥–æ–≤–æ—Ä–∏—Ç TypeScript: "—è —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —ç—Ç–æ –Ω–µ undefined".

1.4 Singleton-–ø–æ–¥—Ö–æ–¥ (–ø–∞—Ç—Ç–µ—Ä–Ω –æ–¥–∏–Ω–æ—á–∫–∏)
  –¢—ã —Å–æ–∑–¥–∞—ë—à—å –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä PrismaClient –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—à—å –µ–≥–æ.
  –ü–æ—Ç–æ–º –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—à—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç prisma.
  –≠—Ç–æ –≤–∞–∂–Ω–æ –≤ dev-—Ä–µ–∂–∏–º–µ: –µ—Å–ª–∏ –ø—Ä–∏ hot reload –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π PrismaClient, –±—É–¥—É—Ç —É—Ç–µ—á–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î –∏ –æ—à–∏–±–∫–∞ too many connections.
  üß† –ò–¥–µ—è: –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å ‚Üí –æ–¥–∏–Ω PrismaClient ‚Üí –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
*/

/*
  2. –§—É–Ω–∫—Ü–∏—è getUserFromDb
    –ë–µ—Ä—ë—Ç –æ–±—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä prisma.
    –û–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –º–æ–¥–µ–ª–∏ User (–æ–Ω–∞ –æ–ø–∏—Å–∞–Ω–∞ –≤ schema.prisma –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ generated/prisma/client).
    –ò—â–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ø–æ–ª—é email (@@unique –∏–ª–∏ @unique –≤ Prisma-—Å—Ö–µ–º–µ).
    –õ–æ–≥–∏–∫–∞ –ø—Ä–æ—Å—Ç–∞—è: email ‚Üí user || null.
*/

/*
  3. –°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Zod (signInSchema)
  zod ‚Äî —ç—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
    object({ ... }) ‚Äî –æ–ø–∏—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É/–æ–±—ä–µ–∫—Ç.
    string() ‚Äî –≥–æ–≤–æ—Ä–∏–º, —á—Ç–æ –ø–æ–ª–µ —Å—Ç—Ä–æ–∫–∞.
    .min, .max, .email ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
    –°–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ 'Email is required' ‚Äî –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞.
  –ü–æ—Ç–æ–º —Ç—ã –¥–µ–ª–∞–µ—à—å:  
    const { email, password } = await signInSchema.parseAsync(credentials);
      –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã ‚Üí –ø–æ–ª—É—á–∞–µ—à—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç { email, password }.
      –ï—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è ZodError.
  –≠—Ç–æ —É–¥–æ–±–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ:
    –Ω–µ –Ω—É–∂–Ω–æ —Ä—É–∫–∞–º–∏ –ø–∏—Å–∞—Ç—å if (!email) ...
    –Ω–µ –Ω—É–∂–Ω–æ —Ä—É–∫–∞–º–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å email-—Ñ–æ—Ä–º–∞—Ç
    —É —Ç–µ–±—è —Ç–∏–ø—ã –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.
*/

/*
  4. –ö–æ–Ω—Ñ–∏–≥ NextAuth
  4.1. –ó–∞—á–µ–º –Ω—É–∂–µ–Ω NextAuth
  NextAuth ‚Äî –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ Next.js:
    –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—è–º–∏ (—á–µ—Ä–µ–∑ –∫—É–∫–∏ / JWT).
    –î–∞—ë—Ç –≥–æ—Ç–æ–≤—ã–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã (handlers) –¥–ª—è route handlers (GET/POST /api/auth/[...nextauth]).
    –î–æ—Å—Ç–∞—ë—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ server components —á–µ—Ä–µ–∑ auth().
    –î–∞—ë—Ç —Ñ—É–Ω–∫—Ü–∏–∏ signIn() –∏ signOut() –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞.

    –¢—ã –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—à—å:
    export const { handlers, signIn, signOut, auth } = NextAuth({...});
      handlers ‚Äî –æ–±—ä–µ–∫—Ç —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (GET, POST) –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
      signIn ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω–∞—è helper-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Ö–æ–¥–∞.
      signOut ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω–∞—è helper-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—Ö–æ–¥–∞.
      auth ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.


  4.2. –ó–∞—á–µ–º –Ω—É–∂–µ–Ω PrismaAdapter
    adapter: PrismaAdapter(prisma),
    NextAuth —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–µ –∑–Ω–∞–µ—Ç, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–µ—Å—Å–∏–∏, –∫–ª—é—á–∏, –∞–∫–∫–∞—É–Ω—Ç—ã –∏ —Ç.–¥.
    PrismaAdapter:
      –ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç NextAuth, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–π —á–µ—Ä–µ–∑ Prisma.
      –û–∂–∏–¥–∞–µ—Ç, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ Prisma-–º–æ–¥–µ–ª–∏ (User, Account, Session, VerificationToken).
      –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/—á—Ç–µ–Ω–∏–µ:
        –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
        —Å–µ—Å—Å–∏–π,
        —Å–≤—è–∑–µ–π —Å OAuth-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∏ —Ç.–ø.
   –¢–æ –µ—Å—Ç—å NextAuth + PrismaAdapter = "NextAuth, –≤–æ—Ç —Ç–µ–±–µ Prisma ‚Äî —Ö—Ä–∞–Ω–∏ –≤—Å—ë –≤ PostgreSQL".   
   
   4.3. Credentials Provider
   Credentials Provider ‚Äî —ç—Ç–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä NextAuth –¥–ª—è –ª–æ–≥–∏–Ω–∞ –ø–æ —Å–≤–æ–∏–º –ø–æ–ª—è–º (email + –ø–∞—Ä–æ–ª—å, username + pin –∏ —Ç.–¥.).
      credentials –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –æ–∂–∏–¥–∞–µ—à—å —Å —Ñ–æ—Ä–º—ã.
      –í authorize —Ç—ã —Å–∞–º –æ–ø–∏—Å—ã–≤–∞–µ—à—å, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
      –ï—Å–ª–∏ authorize:
        –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ª–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω.
        –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null ‚Üí –ª–æ–≥–∏–Ω –Ω–µ—É—Å–ø–µ—à–µ–Ω.
        –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É ‚Üí –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ—É—Å–ø–µ—Ö–æ–º / —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –æ—à–∏–±–∫–æ–π.

   4.4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç authorize
    –ü–æ—à–∞–≥–æ–≤–æ:
      –ü—Ä–∏—Ö–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å –ª–æ–≥–∏–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ signIn('credentials', {...})).
      NextAuth –∑–∞–±–∏—Ä–∞–µ—Ç credentials (email + password).
      –í—ã–∑—ã–≤–∞–µ—Ç —Ç–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é:
        authorize: async (credentials) => { ... }
          –í–Ω—É—Ç—Ä–∏:
            –ü—Ä–æ–≤–µ—Ä—è–µ—à—å, —á—Ç–æ –ø–æ–ª—è –Ω–µ –ø—É—Å—Ç—ã–µ. if (!credentials?.email || !credentials?.password) {
            –ü—Ä–æ–≥–æ–Ω—è–µ—à—å credentials —á–µ—Ä–µ–∑ signInSchema.parseAsync (–≤–∞–ª–∏–¥–∞—Ü–∏—è Zod).
              –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ—à–ª–∏ ‚Üí ZodError.
            –ò—â–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ:
            const user = await getUserFromDb(email);
              –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω / –Ω–µ—Ç –ø–∞—Ä–æ–ª—è ‚Üí –æ—à–∏–±–∫–∞.
            –°—Ä–∞–≤–Ω–∏–≤–∞–µ—à—å –ø–∞—Ä–æ–ª–∏ —á–µ—Ä–µ–∑ bcryptjs.compare:
              –ï—Å–ª–∏ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Üí –æ—à–∏–±–∫–∞.password ‚Äî –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–≤—ë–ª —é–∑–µ—Ä.
              user.password ‚Äî —Ö—ç—à –ø–∞—Ä–æ–ª—è –≤ –±–∞–∑–µ.
           –ï—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
              return { id: user.id, email: user.email };   
           NextAuth –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é –∏ –∫–ª–∞–¥—ë—Ç –Ω—É–∂–Ω–æ–µ –≤ –∫—É–∫–∏.

     5. bcryptjs ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª–µ–π.
      –ü–∞—Ä–æ–ª–∏ –Ω–µ–ª—å–∑—è —Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑–µ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ.
      –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
        –±–µ—Ä—ë—à—å –ø–∞—Ä–æ–ª—å,
        –¥–µ–ª–∞–µ—à—å bcrypt.hash(plainPassword, saltRounds),
        —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å —Ö—ç—à.
      –ü—Ä–∏ –ª–æ–≥–∏–Ω–µ:
        –±–µ—Ä—ë—à—å –ø–∞—Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
        –≤—ã–∑—ã–≤–∞–µ—à—å bcrypt.compare(plainPassword, hashFromDb).
      –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∞–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Ö—ç—à.
      –ò–¥–µ—è: —Å–µ—Ä–≤–µ—Ä –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–Ω–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å, —Ç–æ–ª—å–∫–æ —Ö—ç—à.

      6. –ó–∞—á–µ–º –Ω—É–∂–µ–Ω ZodError –≤ catch
      } catch (error) {
        if (error instanceof ZodError) {
          return null;
      }
          return null;
      }
      –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é ‚Üí –±—Ä–æ—Å–∞–µ—Ç—Å—è ZodError.
      –¢—ã –ª–æ–≤–∏—à—å –µ–≥–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å null, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç NextAuth:
      "–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω".
      –°–µ–π—á–∞—Å —É —Ç–µ–±—è –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è null, –Ω–æ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ:
        –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –ø–æ-—Ä–∞–∑–Ω–æ–º—É,
        –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI.

      7. –ò—Ç–æ–≥–æ: –∫–∞–∫ –≤—Å—è —Å–≤—è–∑–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
      7.1 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Ñ–æ—Ä–º–µ –ª–æ–≥–∏–Ω–∞ –≤–≤–æ–¥–∏—Ç email + –ø–∞—Ä–æ–ª—å.
      7.2 –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/auth/callback/credentials (–∏–ª–∏ —á–µ—Ä–µ–∑ signIn('credentials', ...)).
      7.3. NextAuth –≤—ã–∑—ã–≤–∞–µ—Ç authorize.
      7.4 authorize:
        –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Zod,
        –¥–æ—Å—Ç–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Prisma,
        –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ bcrypt.
      7.5 –ï—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Üí authorize –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { id, email }.
      7.6 NextAuth:
        —Å–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ User (—á–µ—Ä–µ–∑ PrismaAdapter, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ),
        —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é (Session),
        –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç –∫—É–∫—É —Å session token.
      7.7. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ç—ã –º–æ–∂–µ—à—å –≤—ã–∑—ã–≤–∞—Ç—å auth() –∏ –ø–æ–ª—É—á–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
      
      8. –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ ‚Äî signIn, signOut –∏ —Ç.–ø.    
*/
